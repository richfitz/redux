<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Redis with redux • redux</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Redis with redux">
<meta property="og:description" content="redux">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">redux</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/redux.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/low_level.html">Low level implementation details</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/richfitz/redux/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Redis with redux</h1>
                        <h4 data-toc-skip class="author">Rich
FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2023-12-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/richfitz/redux/blob/HEAD/vignettes/redux.Rmd" class="external-link"><code>vignettes/redux.Rmd</code></a></small>
      <div class="hidden name"><code>redux.Rmd</code></div>

    </div>

    
    
<p><code>redux</code> provides a full interface to the Redis API; it
provides a hiredis driver wrapped in R and uses this to expose all 199
Redis commands as a set of user-friendly R functions that do basic error
checking.</p>
<p>It is possible to build user-friendly applications on top of this,
for example <a href="https://github.com/richfitz/storr" class="external-link"><code>storr</code></a> which
provides a content-addressable object store, and <a href="https://github.com/traitecoevo/rrqueue" class="external-link"><code>rrqueue</code></a> /
<a href="https://github.com/mrc-ide/rrq" class="external-link"><code>rrq</code></a> which
implement a scalable queuing system.</p>
<p>The main entry point for creating a <code>redis_api</code> object is
the <code>hiredis</code> function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/hiredis.html">hiredis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>By default, it will connect to a database running on the local
machine (<code>127.0.0.1</code>) and port 6379. To connect to a
different host, or to specify a password, initial database, or to use a
socket connection, use the command .</p>
<p>The <code>redis_api</code> object is an <a href="https://github.com/r-lib/R6" class="external-link"><code>R6</code></a> class with
<em>many</em> methods, each corresponding to a different Redis
command.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;redis_api&gt;</span></span>
<span><span class="co">##   Redis commands:</span></span>
<span><span class="co">##     APPEND: function</span></span>
<span><span class="co">##     AUTH: function</span></span>
<span><span class="co">##     BGREWRITEAOF: function</span></span>
<span><span class="co">##     BGSAVE: function</span></span>
<span><span class="co">##     ...</span></span>
<span><span class="co">##     ZSCORE: function</span></span>
<span><span class="co">##     ZUNIONSTORE: function</span></span>
<span><span class="co">##   Other public methods:</span></span>
<span><span class="co">##     clone: function</span></span>
<span><span class="co">##     command: function</span></span>
<span><span class="co">##     config: function</span></span>
<span><span class="co">##     initialize: function</span></span>
<span><span class="co">##     pipeline: function</span></span>
<span><span class="co">##     reconnect: function</span></span>
<span><span class="co">##     subscribe: function</span></span>
<span><span class="co">##     type: function</span></span>
<span><span class="co">##     version: function</span></span></code></pre>
<p>For example, <code>SET</code> and <code>GET</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">SET</span><span class="op">(</span><span class="st">"mykey"</span>, <span class="st">"mydata"</span><span class="op">)</span> <span class="co"># set the key "mykey" to the value "mydata"</span></span></code></pre></div>
<pre><code><span><span class="co">## [Redis: OK]</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">GET</span><span class="op">(</span><span class="st">"mykey"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mydata"</span></span></code></pre>
<div class="section level2">
<h2 id="serialisation">Serialisation<a class="anchor" aria-label="anchor" href="#serialisation"></a>
</h2>
<p>The value for most arguments must be a string or will be coerced into
one; clearly this is not going to be suitable for most R objects. The
solution is to <em>serialise</em> the R object. <code>redux</code> can
accept objects serialised to strings or to byte streams, and the
functions the <code>object_to_bin</code> and
<code>object_to_string</code> functions can help here, serialising the
objects to binary and string representations. (Alternatively you can do
this yourself using <code>serialize</code>.)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_bin</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">obj</span></span></code></pre></div>
<pre><code><span><span class="co">##   [1] 42 0a 03 00 00 00 02 03 04 00 00 05 03 00 05 00 00 00 55 54 46 2d 38 ee 00</span></span>
<span><span class="co">##  [26] 00 00 02 00 00 00 01 00 00 00 09 00 04 00 0e 00 00 00 63 6f 6d 70 61 63 74</span></span>
<span><span class="co">##  [51] 5f 69 6e 74 73 65 71 02 00 00 00 01 00 00 00 09 00 04 00 04 00 00 00 62 61</span></span>
<span><span class="co">##  [76] 73 65 02 00 00 00 0d 00 00 00 01 00 00 00 0d 00 00 00 fe 00 00 00 0e 00 00</span></span>
<span><span class="co">## [101] 00 03 00 00 00 00 00 00 00 00 00 24 40 00 00 00 00 00 00 f0 3f 00 00 00 00</span></span>
<span><span class="co">## [126] 00 00 f0 3f fe 00 00 00</span></span></code></pre>
<p>or</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">str</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_string</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">str</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "A\n3\n262914\n197888\n5\nUTF-8\n238\n2\n1\n262153\n14\ncompact_intseq\n2\n1\n262153\n4\nbase\n2\n13\n1\n13\n254\n14\n3\n0x1.4p+3\n0x1p+0\n0x1p+0\n254\n"</span></span></code></pre>
<p>The binary serialisation is faster, smaller, and preserves all the
bits of floating point numbers. The string version might be preferable
where having only strings in the database is wanted. The binary
serialisation is compatible with the same approach used in
<code>RcppRedis</code>, though it is never done automatically.</p>
<p>These values can be deserialised:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">bin_to_object</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">string_to_object</a></span><span class="op">(</span><span class="va">str</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span></code></pre>
<p>So:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">SET</span><span class="op">(</span><span class="st">"mylist"</span>, <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_bin</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [Redis: OK]</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">GET</span><span class="op">(</span><span class="st">"mylist"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   [1] 42 0a 03 00 00 00 02 03 04 00 00 05 03 00 05 00 00 00 55 54 46 2d 38 ee 00</span></span>
<span><span class="co">##  [26] 00 00 02 00 00 00 01 00 00 00 09 00 04 00 0e 00 00 00 63 6f 6d 70 61 63 74</span></span>
<span><span class="co">##  [51] 5f 69 6e 74 73 65 71 02 00 00 00 01 00 00 00 09 00 04 00 04 00 00 00 62 61</span></span>
<span><span class="co">##  [76] 73 65 02 00 00 00 0d 00 00 00 01 00 00 00 0d 00 00 00 fe 00 00 00 0e 00 00</span></span>
<span><span class="co">## [101] 00 03 00 00 00 00 00 00 00 00 00 24 40 00 00 00 00 00 00 f0 3f 00 00 00 00</span></span>
<span><span class="co">## [126] 00 00 f0 3f fe 00 00 00</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">bin_to_object</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="fu">GET</span><span class="op">(</span><span class="st">"mylist"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span></code></pre>
<p>Using string serialisation is similar:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">SET</span><span class="op">(</span><span class="st">"mylist"</span>, <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_string</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [Redis: OK]</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">GET</span><span class="op">(</span><span class="st">"mylist"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "A\n3\n262914\n197888\n5\nUTF-8\n238\n2\n1\n262153\n14\ncompact_intseq\n2\n1\n262153\n4\nbase\n2\n13\n1\n13\n254\n14\n3\n0x1.4p+3\n0x1p+0\n0x1p+0\n254\n"</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">string_to_object</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="fu">GET</span><span class="op">(</span><span class="st">"mylist"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span></code></pre>
<p>This gives you all the power of Redis, but you will have to manually
serialise/deserialise all complicated R objects (i.e., everything other
than logicals, numbers or strings). Similarly, you are responsible for
type coercion/deserialisation when retrieving data at the other end.</p>
<p>Note that you are not restricted to using serialised R objects as
values; you can use them as keys; this is perfectly valid:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">SET</span><span class="op">(</span><span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_bin</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, <span class="st">"mydata"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [Redis: OK]</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">GET</span><span class="op">(</span><span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_bin</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mydata"</span></span></code></pre>
<p>Beyond <code>GET</code> / <code>SET</code> / <code>DEL</code>, Redis
offers potentially better ways of holding things like lists using its
native data types. For example;</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">RPUSH</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10</span></span></code></pre>
<p>(the returned value <code>10</code> indicates that the list “mylist2”
is 10 elements long). There are lots of commands for operating on lists.
For example, you can do things like;</p>
<ul>
<li>get an element by its index (note that this uses C-style base-0
indexing for consistency with the <code>Redis</code> documentation
rather than R’s semantics)</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LINDEX</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "2"</span></span></code></pre>
<ul>
<li>set an element by its index</li>
</ul>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LSET</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fl">1</span>, <span class="st">"carrot"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [Redis: OK]</span></span></code></pre>
<ul>
<li>get all of a list:</li>
</ul>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LRANGE</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] "1"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "carrot"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "3"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">## [1] "4"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[5]]</span></span>
<span><span class="co">## [1] "5"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[6]]</span></span>
<span><span class="co">## [1] "6"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[7]]</span></span>
<span><span class="co">## [1] "7"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[8]]</span></span>
<span><span class="co">## [1] "8"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[9]]</span></span>
<span><span class="co">## [1] "9"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[10]]</span></span>
<span><span class="co">## [1] "10"</span></span></code></pre>
<ul>
<li>or part of it:</li>
</ul>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LRANGE</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] "1"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "carrot"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "3"</span></span></code></pre>
<ul>
<li>pop elements off the front or back</li>
</ul>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LLEN</span><span class="op">(</span><span class="st">"mylist2"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LPOP</span><span class="op">(</span><span class="st">"mylist2"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "1"</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">RPOP</span><span class="op">(</span><span class="st">"mylist2"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "10"</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LLEN</span><span class="op">(</span><span class="st">"mylist2"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 8</span></span></code></pre>
<p>Of course, each element of the list can be an R object if you run it
through <code>object_to_string</code>:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">LPUSH</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_string</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 9</span></span></code></pre>
<p>but you’ll be responsible for converting that back (and detecting /
knowing that this needs doing)</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="fu">LRANGE</span><span class="op">(</span><span class="st">"mylist2"</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">dat</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] "A\n3\n262914\n197888\n5\nUTF-8\n238\n2\n1\n262153\n14\ncompact_intseq\n2\n1\n262153\n4\nbase\n2\n13\n1\n13\n254\n14\n3\n0x1.4p+3\n0x1p+0\n0x1p+0\n254\n"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "carrot"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "3"</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">string_to_object</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dat</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "carrot"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "3"</span></span></code></pre>
<p>As with all functions in the <code>redis_api</code> object, all
functions and their arguments are described in the Redis
documentation.</p>
</div>
<div class="section level2">
<h2 id="pipelining">Pipelining<a class="anchor" aria-label="anchor" href="#pipelining"></a>
</h2>
<p>Every command set to Redis costs a round trip; even over the loopback
interface this can be expensive if done a very large number of times.
Redis offers two ways of minimising this problem; pipelining and lua
scripting. redux supports both.</p>
<p>To pipeline, use the <code>pipeline</code> method of the
<code>hiredis</code> object:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">redis</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="va"><a href="../reference/redis.html">redis</a></span></span>
<span><span class="va">r</span><span class="op">$</span><span class="fu">pipeline</span><span class="op">(</span></span>
<span>  <span class="va">redis</span><span class="op">$</span><span class="fu">PING</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">redis</span><span class="op">$</span><span class="fu">PING</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [Redis: PONG]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [Redis: PONG]</span></span></code></pre>
<p>Here, <code>redis</code> is a special object within the package that
implements all the Redis commands but only formats them for use rather
than sends them. The <code>pipeline</code> method collects these all up
and sends them to the server in a single batch, with the result returned
as a list.</p>
<p>If arguments are named, then the return value is named:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">pipeline</span><span class="op">(</span></span>
<span>  a <span class="op">=</span> <span class="va">redis</span><span class="op">$</span><span class="fu">INCR</span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="va">redis</span><span class="op">$</span><span class="fu">INCR</span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>,</span>
<span>  c <span class="op">=</span> <span class="va">redis</span><span class="op">$</span><span class="fu">DEL</span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $a</span></span>
<span><span class="co">## [1] 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $b</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $c</span></span>
<span><span class="co">## [1] 1</span></span></code></pre>
<p>here a variable “x” was incremented twice and then deleted.</p>
<p>If you use pipelining you should read the Redis page on it
(<code>http://redis.io/topics/pipelining</code>) because there are a few
restrictions and cautions.</p>
<p>Generating very large numbers (or variable numbers) of commands with
the above interface will be difficult because <code>pipeline</code> uses
the dots argument. Instead, you can pass a list of commands to the
<code>.commands</code> argument of <code>pipeline</code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="va">redis</span><span class="op">$</span><span class="fu">PING</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r</span><span class="op">$</span><span class="fu">pipeline</span><span class="op">(</span>.commands <span class="op">=</span> <span class="va">cmds</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [Redis: PONG]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [Redis: PONG]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [Redis: PONG]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">## [Redis: PONG]</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="subscriptions">Subscriptions<a class="anchor" aria-label="anchor" href="#subscriptions"></a>
</h2>
<p>On top of the key/value store aspect of Redis, it also offers a
publisher/subscriber model. Publishing with <code>redux</code> is
straightforward; use the <code>PUBLISH</code> method:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">PUBLISH</span><span class="op">(</span><span class="st">"mychannel"</span>, <span class="st">"hello"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<p>The return value here is the number of subscribers to that channel;
in our case zero!</p>
<p>The <code>SUBSCRIBE</code> method should not be used as the client
cannot deal with messages directly (it is disabled in the interface to
prevent this).</p>
<p>Instead, use the <code>subscribe</code> (lower case) method. This
takes arguments:</p>
<ul>
<li><p><code>channel</code>: name or pattern of the channel/s to
subscribe to (scalar or vector).</p></li>
<li><p><code>transform</code>: A function that takes each message and
processes it. Messages are R lists with elements: <code>type</code>,
<code>pattern</code> (if a pattern was used), <code>channel</code> and
<code>value</code> (see the Redis docs). Your transform function can
turn this into anything it wants, and may have side effects such as
printing to the screen, writing to a file, etc.</p></li>
<li><p><code>terminate</code>: A termination criterion. given a
<em>transformed</em> message (i.e., the result of
<code>transform(x)</code>) return <code>TRUE</code> if we’re processing
messages. Optional, but if not used set <code>n</code> to a finite
number.</p></li>
<li><p>collect: logical indicating if <em>transformed</em> messages
should be collected and returned on exit.</p></li>
<li><p>n: maximum number of messages to collect; once <code>n</code>
messages have been collected we will terminate regardless of
<code>terminate</code>.</p></li>
<li><p>pattern: logical indicating if <code>channel</code> should be
interpreted as a pattern.</p></li>
<li><p>envir: environment in which to evaluate <code>transform</code>
and <code>terminate</code>.</p></li>
</ul>
<p>That all sounds a lot more complicated it really is. To collect all
messages on the <code>"mychannel"</code> channel, stopping after 100
messages or a message reading exactly “goodbye” you would write:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="fu">subscribe</span><span class="op">(</span><span class="st">"mychannel"</span>,</span>
<span>                   transform <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">value</span>,</span>
<span>                   terminate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"goodbye"</span><span class="op">)</span>,</span>
<span>                   n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><em>NOTE</em>: you need to be careful here - <code>hiredis</code>
internally uses a blocking read which cannot be interrupted with Ctrl-C
once started unless a message is received on the channels being listened
to!</p>
<p>To test this out, we need a second process that will publish to the
channel (or we’ll wait forever). This function will publish the first 20
values out of the Nile data set.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/hiredis.html">hiredis</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">Nile</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">.05</span><span class="op">)</span></span>
<span>  <span class="va">r</span><span class="op">$</span><span class="fu">PUBLISH</span><span class="op">(</span><span class="st">"mychannel"</span>, <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">r</span><span class="op">$</span><span class="fu">PUBLISH</span><span class="op">(</span><span class="st">"mychannel"</span>, <span class="st">"goodbye"</span><span class="op">)</span></span></code></pre></div>
<p>This file is at <code>path_to_publisher</code> (in R’s temporary
directory) and can be run with:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home</a></span><span class="op">(</span><span class="st">"bin"</span><span class="op">)</span>, <span class="st">"Rscript"</span><span class="op">)</span>, <span class="va">path_to_publisher</span>,</span>
<span>        wait <span class="op">=</span> <span class="cn">FALSE</span>, stdout <span class="op">=</span> <span class="cn">FALSE</span>, stderr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>to start the publisher.</p>
<p>Let’s add a little debugging information to the transform function,
and set the subscriber off:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transform</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y-%m-%d %H:%M:%OS3"</span><span class="op">)</span>,</span>
<span>          <span class="st">": got message: "</span>,</span>
<span>          <span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="fu">subscribe</span><span class="op">(</span><span class="st">"mychannel"</span>,</span>
<span>                   transform <span class="op">=</span> <span class="va">transform</span>,</span>
<span>                   terminate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"goodbye"</span><span class="op">)</span>,</span>
<span>                   n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.369: got message: 1120</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.468: got message: 1160</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.573: got message: 963</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.665: got message: 1210</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.735: got message: 1160</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.837: got message: 1160</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:37.922: got message: 813</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.019: got message: 1230</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.120: got message: 1370</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.240: got message: 1140</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.321: got message: 995</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.441: got message: 935</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.523: got message: 1110</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.625: got message: 994</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.725: got message: 1020</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.833: got message: 960</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:38.955: got message: 1180</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:39.057: got message: 799</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:39.160: got message: 958</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:39.258: got message: 1140</span></span></code></pre>
<pre><code><span><span class="co">## 2023-12-04 11:19:39.258: got message: goodbye</span></span></code></pre>
<p>The timestamps in the printed output show when the message was
received (with fractional seconds so that this is more obvious since
this only takes ~1s to complete).</p>
<p>The <code>res</code> object contains all the values, including the
“goodbye” that was our end-of-stream message:</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "1120"    "1160"    "963"     "1210"    "1160"    "1160"    "813"    </span></span>
<span><span class="co">##  [8] "1230"    "1370"    "1140"    "995"     "935"     "1110"    "994"    </span></span>
<span><span class="co">## [15] "1020"    "960"     "1180"    "799"     "958"     "1140"    "goodbye"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="potential-applications">Potential applications<a class="anchor" aria-label="anchor" href="#potential-applications"></a>
</h2>
<p>Because <code>redux</code> exposes all of Redis, you can roll your
own data structures.</p>
<p>First, a generator object that sets up a new list at <code>key</code>
within the database <code>r</code>.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rlist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">key</span> <span class="op">=</span> <span class="st">"rlist"</span>, <span class="va">r</span> <span class="op">=</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/hiredis.html">hiredis</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>, <span class="fu">redux</span><span class="fu">::</span><span class="va"><a href="../reference/object_to_string.html">object_to_string</a></span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r</span><span class="op">$</span><span class="fu">RPUSH</span><span class="op">(</span><span class="va">key</span>, <span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, key <span class="op">=</span> <span class="va">key</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">ret</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"rlist"</span></span>
<span>  <span class="va">ret</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then some S3 methods that work with this object. I’ve only
implemented <code>length</code> and <code>[[</code>, but <code>[</code>
would be useful here too as would <code>print</code>.</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">length.rlist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">r</span><span class="op">$</span><span class="fu">LLEN</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">key</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">`[[.rlist`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">i</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">string_to_object</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">r</span><span class="op">$</span><span class="fu">LINDEX</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">key</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">`[[&lt;-.rlist`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">i</span>, <span class="va">value</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">$</span><span class="va">r</span><span class="op">$</span><span class="fu">LSET</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">key</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">1L</span>, <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/object_to_string.html">object_to_string</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then we have this weird object we can add things to.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">rlist</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="co"># 10</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10</span></span></code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"an element"</span></span>
<span><span class="va">obj</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "an element"</span></span></code></pre>
<p>The object has reference semantics so that assignment does
<em>not</em> make a copy:</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj2</span> <span class="op">&lt;-</span> <span class="va">obj</span></span>
<span><span class="va">obj2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obj2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="va">obj</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="va">obj2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>For a better version of this, see <a href="https://github.com/richfitz/storr" class="external-link">storr</a> which does similar
things to implement “<a href="http://htmlpreview.github.io/?https://raw.githubusercontent.com/richfitz/storr/master/inst/doc/storr.html#lists-and-indexable-serialisation" class="external-link">indexable
serialisation</a>”</p>
</div>
<div class="section level2">
<h2 id="scripts">Scripts<a class="anchor" aria-label="anchor" href="#scripts"></a>
</h2>
<p>Redis allows storing and evaluating Lua scripts on the redis server.
At this point it’s all getting a bit meta (using R to tell Redis to call
another dynamic language that drives Redis) but this can be very useful
- especially in avoiding race conditions (because a script is atomic)
and avoiding roundtrips.</p>
<p>Describing how to write Lua scripts is out of scope for this document
but is a bit fiddly. Here is a trivial one that returns the value of a
key:</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">SET</span><span class="op">(</span><span class="st">"key"</span>, <span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [Redis: OK]</span></span></code></pre>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="fu">EVAL</span><span class="op">(</span><span class="st">"return redis.call('get', 'key')"</span>, <span class="fl">1L</span>, <span class="st">"key"</span>, <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>This can also be run by pushing the script into Redis and referring
to it by SHA:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sha</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="fu">SCRIPT_LOAD</span><span class="op">(</span><span class="st">"return redis.call('get', 'key')"</span><span class="op">)</span></span>
<span><span class="va">r</span><span class="op">$</span><span class="fu">SCRIPT_EXISTS</span><span class="op">(</span><span class="va">sha</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 1</span></span></code></pre>
<p>and calling it like so:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="fu">EVALSHA</span><span class="op">(</span><span class="va">sha</span>, <span class="fl">1</span>, <span class="st">"key"</span>, <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a"</span></span></code></pre>
<p>A more interesting example, setting, incrementing and getting a key
(this is all do-able with redis commands)</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lua</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">  local keyname = KEYS[1]</span></span>
<span><span class="st">  local value = ARGV[1]</span></span>
<span><span class="st">  redis.call("SET", keyname, value)</span></span>
<span><span class="st">  redis.call("INCR", keyname)</span></span>
<span><span class="st">  return redis.call("GET", keyname)'</span></span></code></pre></div>
<p>With the <code>redis_scripts</code> wrapper you can give friendly
names to a script:</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">redux</span><span class="fu">::</span><span class="fu"><a href="../reference/redis_scripts.html">redis_scripts</a></span><span class="op">(</span><span class="va">r</span>, set_and_incr <span class="op">=</span> <span class="va">lua</span><span class="op">)</span></span></code></pre></div>
<p>And then call them by name:</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">obj</span><span class="op">(</span><span class="st">"set_and_incr"</span>, <span class="st">"foo"</span>, <span class="st">"10"</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "11"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="getting-help">Getting help<a class="anchor" aria-label="anchor" href="#getting-help"></a>
</h2>
<p>Because the interface <code>redux</code> uses is simply a wrapper
around the Redis API, the main source of documentation is the Redis help
itself at <code>http://redis.io</code></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
